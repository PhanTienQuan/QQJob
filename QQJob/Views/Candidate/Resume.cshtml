@model QQJob.ViewModels.CandidateViewModels.ResumeViewModal
@{
    ViewBag.Title = "Upload Resume";
    var tempMessage = TempData["Message"] as string;
    bool hasResume = !string.IsNullOrEmpty(Model.ResumeUrl);
}
<!-- content area -->
<div class="dashboard__content d-flex template-dashboard ">
    <partial name="_LeftMenu" />
    <div class="dashboard__right">
        <div class="dash__content ">
            <!-- sidebar menu -->
            <div class="sidebar__menu d-md-block d-lg-none">
                <div class="sidebar__action"><i class="fa-sharp fa-regular fa-bars"></i> Sidebar</div>
            </div>
            <!-- sidebar menu end -->
            <div class="my__profile__tab radius-16 bg-white">
                <form asp-action="Resume" asp-controller="Candidate" method="post" enctype="multipart/form-data">
                    <div class="my__details" id="info">
                        <div class="mt-4" id="preview-container">
                            @if (hasResume)
                            {
                                <label>Preview:</label>
                                <iframe id="resumePreview" src="@Model.ResumeUrl" width="100%" height="600px" style="border:1px solid #ccc;"></iframe>
                            }
                            else
                            {
                                <iframe id="resumePreview" style="display:none;" width="100%" height="600px" style="border:1px solid #ccc;"></iframe>
                            }
                        </div>
                        <div class="info__top align-items-start flex-column">
                            @if (!string.IsNullOrEmpty(tempMessage))
                            {
                                <div class="alert alert-success">@tempMessage</div>
                            }
                            <div class="info__field">
                                @if (!hasResume)
                                {
                                    <input type="file" asp-for="ResumeFile" class="form-control mb-3" accept="application/pdf" />
                                    <span asp-validation-for="ResumeFile" class="text-danger"></span>
                                    <button type="submit" class="rts__btn fill__btn mx-0">Upload New Resume</button>
                                }
                                else
                                {
                                    <input type="file" asp-for="ResumeFile" class="form-control mb-3" accept="application/pdf" />
                                    <span asp-validation-for="ResumeFile" class="text-danger"></span>
                                    <button type="submit" class="rts__btn fill__btn mx-0">Submit Resume</button>
                                }
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- education -->
            <h6 class="fw-medium mt-30 mb-20">Education</h6>
            <div class="my__education radius-16 p-30 bg-white" id="education">
                <div class="accordion" id="education-accordion">
                    @for (int i = 0; i < Model.Educations.Count; i++)
                    {
                        var edu = Model.Educations[i];
                        var collapseId = $"edu-collapse-{edu.EducationId}";
                        <div class="accordion-item mb-3">
                            <h2 class="accordion-header" id="heading-@edu.EducationId">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#@collapseId" aria-expanded="false" aria-controls="@collapseId">
                                    @edu.UniversityName
                                </button>
                            </h2>
                            <div id="@collapseId" class="accordion-collapse collapse" aria-labelledby="heading-@edu.EducationId" data-bs-parent="#education-accordion">
                                <div class="accordion-body p-0 mt-3 mb-20">
                                    <form class="education-item-form" data-id="@edu.EducationId">
                                        @Html.AntiForgeryToken()
                                        <div class="info__field">
                                            <div class="row row-cols-sm-2 row-cols-1">
                                                <div class="rt-input-group">
                                                    <label>University Name</label>
                                                    <input type="text" name="universityName" class="form-control" value="@edu.UniversityName" required>
                                                </div>
                                            </div>
                                            <div class="row row-cols-sm-2 row-cols-md-3 row-cols-1">
                                                <div class="rt-input-group">
                                                    <label>Start date</label>
                                                    <input type="date" name="startDate" class="form-control" value="@(edu.StartDate?.ToString("yyyy-MM-dd"))">
                                                </div>
                                                <div class="rt-input-group">
                                                    <label>End Date</label>
                                                    <input type="date" name="endDate" class="form-control" value="@(edu.EndDate?.ToString("yyyy-MM-dd"))">
                                                </div>
                                            </div>
                                            <div class="rt-input-group">
                                                <label>Description</label>
                                                <textarea name="description" class="form-control">@edu.Description</textarea>
                                            </div>
                                        </div>
                                        <div class="row mt-30">
                                            <div class="col d-flex justify-content-end mt-30">
                                                <button type="button" class="added__social__link" data-id="@edu.EducationId">Save</button>
                                            </div>
                                            <div class="col d-flex justify-content-end mt-30">
                                                <button type="button" class="added__social__link" data-id="@edu.EducationId">Delete</button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    }
                </div>
                <div class="d-flex justify-content-start">
                    <a href="#" class="added__social__link">Add Education</a>
                </div>
                </div>
            </div>
            <!-- education end -->
            <!-- education -->
            <h6 class="fw-medium mt-30 mb-20">Skill & Experience</h6>
            <div class="my__education radius-16 p-30 bg-white" id="education-1">
                <div class="my__skillset">
                    <ul class="skill__tags">
                        <li><span class="skill__item">HTML</span> <span><i class="fa-regular fa-xmark"></i></span> </li>
                        <li><span class="skill__item">C++</span> <span><i class="fa-regular fa-xmark"></i></span> </li>
                        <li><span class="skill__item">Wordpress</span> <span><i class="fa-regular fa-xmark"></i></span> </li>
                        <li><span class="skill__item">JQuery</span> <span><i class="fa-regular fa-xmark"></i></span> </li>
                        <li><span class="skill__item">Website Development</span> <span><i class="fa-regular fa-xmark"></i></span> </li>
                        <li><span class="skill__item">Figma</span> <span><i class="fa-regular fa-xmark"></i></span> </li>
                        <li><span class="skill__item">CSS</span> <span><i class="fa-regular fa-xmark"></i></span> </li>
                        <li><span class="skill__item__add"><i class="fa-regular fa-plus"></i></span></li>
                    </ul>
                </div>
                <div class="accordion" id="rts-accordion-2">
                    <div class="accordion-item">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#c1" aria-expanded="false" aria-controls="c1">
                            Software Engineer
                        </button>
                        <div id="c1" class="accordion-collapse collapse" data-bs-parent="#rts-accordion-2">
                            <div class="accordion-body p-0 mt-3 mb-20">
                                <div class="info__field">
                                    <div class="row row-cols-sm-2 row-cols-1">
                                        <div class="rt-input-group">
                                            <label for="title-4">Title</label>
                                            <input type="text" id="title-4" placeholder="Software Engineer" required>
                                        </div>
                                        <div class="rt-input-group">
                                            <label for="cm-4">Company</label>
                                            <input type="text" id="cm-4" placeholder="Reactheme" required>
                                        </div>
                                    </div>
                                    <div class="row row-cols-sm-2 row-cols-1">
                                        <div class="rt-input-group">
                                            <label for="de-4">end date</label>
                                            <input type="text" id="de-4" placeholder="DD/ MM/ YY" required>
                                        </div>
                                        <div class="rt-input-group">
                                            <label for="sd-4">Start Date</label>
                                            <input type="text" id="sd-4" placeholder="DD/MM/YY" required>
                                        </div>
                                    </div>
                                    <div class="rt-input-group">
                                        <label for="desc-4">Description</label>
                                        <textarea name="desc" id="desc-4" cols="30" rows="5" placeholder="Description"></textarea>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-end mt-30">
                                    <a href="#" class="added__social__link">Remove EXperience</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-start">
                        <a href="#" class="added__social__link">Add Skill</a>
                    </div>
                </div>
            </div>
            <!-- education end -->
            <!-- Award -->
            <h6 class="fw-medium mt-30 mb-20">Award</h6>
            <div class="my__education radius-16 p-30 bg-white" id="education-3">
                <div class="accordion" id="rts-accordion-3">
                    <div class="accordion-item">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#c5" aria-expanded="false" aria-controls="c5">
                            Best Candidate
                        </button>
                        <div id="c5" class="accordion-collapse collapse" data-bs-parent="#rts-accordion-3">
                            <div class="accordion-body p-0 mt-3">
                                <div class="info__field">
                                    <div class="row row-cols-sm-2 row-cols-1">
                                        <div class="rt-input-group">
                                            <label for="title-8">Title</label>
                                            <input type="text" id="title-8" placeholder="McMaster Center for Software Certification" required>
                                        </div>
                                        <div class="rt-input-group">
                                            <label for="ye-8">Year</label>
                                            <input type="text" id="ye-8" placeholder="dd/mm/yy" required>
                                        </div>
                                    </div>
                                    <div class="rt-input-group">
                                        <label for="desc-8">Description</label>
                                        <textarea name="desc" id="desc-8" cols="30" rows="5" placeholder="Description"></textarea>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-end mt-30">
                                    <a href="#" class="added__social__link">Remove Award</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-start mt-20">
                        <a href="#" class="added__social__link">Add Award</a>
                    </div>
                </div>
            </div>
            <!-- Award end -->

        </div>
    </div>
</div>
<!-- content area end -->
@section Scripts {
    <script>
        // Preview PDF when select a new CV
        document.getElementById('ResumeFile').addEventListener('change', function (e) {
            var file = e.target.files[0];
            var preview = document.getElementById('resumePreview');
            if (file && file.type === "application/pdf") {
                var fileURL = URL.createObjectURL(file);
                preview.src = fileURL;
                preview.style.display = "block";
            } else {
                preview.src = "";
                preview.style.display = "none";
            }
        });

        // Xử lý lưu education bằng AJAX
        $(document).on('click', '#saveEducationBtn', function (e) {
            e.preventDefault();
            var universityName = $('#un').val();
            var startDate = $('#std').val();
            var endDate = $('#ltd').val();
            var description = $('#desc').val();

            $.ajax({
                url: '@Url.Action("AddEducation", "Candidate")',
                type: 'POST',
                data: {
                    __RequestVerificationToken: $('#educationForm input[name="__RequestVerificationToken"]').val(),
                    universityName: universityName,
                    startDate: startDate,
                    endDate: endDate,
                    description: description
                },
                success: function (res) {
                    if (res.success) {
                        alert(res.message);
                        // TODO: Cập nhật lại danh sách education nếu muốn
                    } else {
                        alert(res.message);
                    }
                },
                error: function () {
                    alert('Error occurred!');
                }
            });
        });

        // Save education
        $(document).on('click', '.save-education-btn', function (e) {
            e.preventDefault();
            var form = $(this).closest('form');
            var educationId = $(this).data('id');
            var token = form.find('input[name="__RequestVerificationToken"]').val();
            $.ajax({
                url: '@Url.Action("UpdateEducation", "Candidate")',
                type: 'POST',
                data: {
                    __RequestVerificationToken: token,
                    educationId: educationId,
                    universityName: form.find('input[name="universityName"]').val(),
                    startDate: form.find('input[name="startDate"]').val(),
                    endDate: form.find('input[name="endDate"]').val(),
                    description: form.find('textarea[name="description"]').val()
                },
                success: function (res) {
                    alert(res.message);
                },
                error: function () {
                    alert('Error occurred!');
                }
            });
        });

        // Delete education
        $(document).on('click', '.delete-education-btn', function (e) {
            e.preventDefault();
            if (!confirm('Are you sure you want to delete this education?')) return;
            var form = $(this).closest('form');
            var educationId = $(this).data('id');
            var token = form.find('input[name="__RequestVerificationToken"]').val();
            $.ajax({
                url: '@Url.Action("DeleteEducation", "Candidate")',
                type: 'POST',
                data: {
                    __RequestVerificationToken: token,
                    educationId: educationId
                },
                success: function (res) {
                    if (res.success) {
                        form.remove();
                    }
                    alert(res.message);
                },
                error: function () {
                    alert('Error occurred!');
                }
            });
        });
    </script>
}